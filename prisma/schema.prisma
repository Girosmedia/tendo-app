// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTH.JS (NEXT-AUTH V5) ADAPTER MODELS
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                    String    @id @default(cuid())
  name                  String?
  jobTitle              String?   @map("job_title")
  email                 String    @unique
  emailVerified         DateTime? @map("email_verified")
  image                 String?
  password              String?
  isSuperAdmin          Boolean   @default(false) @map("is_super_admin")
  currentOrganizationId String?   @map("current_organization_id")

  accounts      Account[]
  sessions      Session[]
  memberships   Member[]
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// MULTI-TENANT CORE MODELS
// ============================================

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  TRIAL
}

model Organization {
  id        String             @id @default(cuid())
  name      String
  slug      String             @unique
  rut       String             @unique
  logoUrl   String?            @map("logo_url")
  status    OrganizationStatus @default(ACTIVE)
  plan      String             @default("BASIC")
  modules   String[]           @default([])
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  members       Member[]
  settings      OrganizationSettings?
  subscription  Subscription?
  categories    Category[]
  products      Product[]
  customers     Customer[]
  documents     Document[]
  projects      Project[]
  projectExpenses ProjectExpense[]
  projectMilestones ProjectMilestone[]
  projectResources ProjectResource[]
  projectPayments ProjectPayment[]
  cashRegisters CashRegister[]
  operationalExpenses OperationalExpense[]
  treasuryMovements TreasuryMovement[]
  credits       Credit[]
  payments      Payment[]
  suppliers     Supplier[]
  accountsPayable AccountPayable[]

  @@map("organizations")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELED
}

model Subscription {
  id             String             @id @default(cuid())
  organizationId String             @unique @map("organization_id")
  
  planId         String             @map("plan_id") // "BASIC" | "PRO"
  status         SubscriptionStatus @default(TRIAL)
  
  // Período actual
  currentPeriodStart DateTime        @map("current_period_start")
  currentPeriodEnd   DateTime        @map("current_period_end")
  
  // Trial
  trialEndsAt    DateTime?          @map("trial_ends_at")
  
  // Métricas
  mrr            Decimal            @default(0) @db.Decimal(10, 2) // Monthly Recurring Revenue
  
  // Timestamps
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  canceledAt     DateTime?          @map("canceled_at")
  
  // Relaciones
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")

  // Identificación
  name           String
  rut            String?
  contactName    String?  @map("contact_name")

  // Contacto
  email          String?
  phone          String?
  address        String?

  // Estado y metadata
  status         SupplierStatus @default(ACTIVE)
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables       AccountPayable[]

  @@index([organizationId])
  @@index([status])
  @@index([name])
  @@map("suppliers")
}

enum AccountPayableStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELED
}

enum AccountPayableDocumentType {
  INVOICE
  RECEIPT
  OTHER
}

model AccountPayable {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  supplierId     String   @map("supplier_id")

  // Documento y control
  documentType   AccountPayableDocumentType @default(INVOICE) @map("document_type")
  documentNumber String?  @map("document_number")
  issueDate      DateTime @map("issue_date")
  dueDate        DateTime @map("due_date")

  // Montos
  amount         Decimal  @db.Decimal(12, 2)
  balance        Decimal  @db.Decimal(12, 2)

  // Estado
  status         AccountPayableStatus @default(PENDING)

  // Metadata
  description    String?
  notes          String?  @db.Text
  createdBy      String   @map("created_by")
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplier       Supplier     @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  treasuryMovements TreasuryMovement[]

  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_payable")
}

model Member {
  id             String     @id @default(cuid())
  userId         String     @map("user_id")
  organizationId String     @map("organization_id")
  role           MemberRole @default(MEMBER)
  isActive       Boolean    @default(true) @map("is_active")
  estimatedCost  Decimal?     @db.Decimal(12, 2) @map("estimated_cost")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@map("members")
}

// ============================================
// TEAM INVITATIONS
// ============================================

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model TeamInvitation {
  id             String           @id @default(cuid())
  organizationId String           @map("organization_id")
  email          String
  role           MemberRole       @default(MEMBER)
  token          String           @unique
  status         InvitationStatus @default(PENDING)
  invitedBy      String           @map("invited_by") // User ID del que envió la invitación
  expiresAt      DateTime         @map("expires_at")
  acceptedAt     DateTime?        @map("accepted_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
  @@index([status])
  @@map("team_invitations")
}

// ============================================
// ORGANIZATION SETTINGS
// ============================================

model OrganizationSettings {
  id             String   @id @default(cuid())
  organizationId String   @unique @map("organization_id")

  // Identidad
  businessName String  @map("business_name")
  tradeName    String? @map("trade_name")
  rut          String
  logoUrl      String? @map("logo_url")

  // Ubicación
  address String?
  city    String?
  region  String?
  country String  @default("Chile")

  // Contacto
  phone   String?
  email   String?
  website String?

  // Fiscales
  taxRegime        String? @map("tax_regime")
  economicActivity String? @map("economic_activity")

  // Regional
  timezone String @default("America/Santiago")
  currency String @default("CLP")
  locale   String @default("es-CL")

  // Comisiones de tarjeta (MVP)
  cardDebitCommissionRate  Decimal      @default(0) @db.Decimal(5, 2) @map("card_debit_commission_rate")
  cardCreditCommissionRate Decimal      @default(0) @db.Decimal(5, 2) @map("card_credit_commission_rate")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  action           String   // CREATE_TENANT, UPDATE_USER, DELETE_TENANT, etc
  resource         String   // "Organization", "User"
  resourceId       String   @map("resource_id")
  changes          Json?    // Diff antes/después
  ipAddress        String?  @map("ip_address")
  isImpersonating  Boolean  @default(false) @map("is_impersonating")
  impersonationId  String?  @map("impersonation_id")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([isImpersonating])
  @@map("audit_logs")
}

// ============================================
// IMPERSONATION (SUPPORT SYSTEM)
// ============================================

model ImpersonationSession {
  id                 String    @id @default(cuid())
  superAdminId       String    @map("super_admin_id")
  targetOrganizationId String  @map("target_organization_id")
  targetUserId       String?   @map("target_user_id") // Si se impersona a usuario específico
  isActive           Boolean   @default(true) @map("is_active")
  expiresAt          DateTime  @map("expires_at")
  endedAt            DateTime? @map("ended_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  @@index([superAdminId])
  @@index([targetOrganizationId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("impersonation_sessions")
}

// ============================================
// PRODUCTS & SERVICES (CATALOG)
// ============================================

enum ProductType {
  PRODUCT
  SERVICE
}

model Category {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  slug           String
  description    String?
  parentId       String?  @map("parent_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     Category[]   @relation("CategoryHierarchy")
  products     Product[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@map("categories")
}

model Product {
  id             String      @id @default(cuid())
  organizationId String      @map("organization_id")
  categoryId     String?     @map("category_id")
  type           ProductType @default(PRODUCT)

  // Identificación
  sku            String      // Puede ser código de barras comercial o SKU generado
  name           String
  description    String?
  imageUrl       String?     @map("image_url")
  
  // Precios
  // IMPORTANTE: price = Precio BRUTO (incluye IVA). Es el monto final que se cobra al cliente.
  // Para obtener el neto: neto = price / (1 + taxRate/100)
  // Para obtener el IVA: iva = price - neto
  price          Decimal     @db.Decimal(10, 2)
  cost           Decimal?    @db.Decimal(10, 2)
  taxRate        Decimal     @default(19) @db.Decimal(5, 2) @map("tax_rate") // IVA 19% por defecto
  
  // Inventario (solo para PRODUCT)
  trackInventory Boolean     @default(false) @map("track_inventory")
  currentStock   Int         @default(0) @map("current_stock")
  minStock       Int         @default(0) @map("min_stock")
  unit           String      @default("unidad") // unidad, kg, litro, metro, etc
  
  // Estado
  isActive       Boolean     @default(true) @map("is_active")
  
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category       Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  documentItems  DocumentItem[]
  projectResources ProjectResource[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([categoryId])
  @@index([type])
  @@index([isActive])
  @@map("products")
}

// ============================================
// CUSTOMERS (CRM LIGHT)
// ============================================

model Customer {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  
  // Identificación
  name           String
  rut            String?
  email          String?
  phone          String?
  
  // Ubicación
  address        String?
  city           String?
  region         String?
  
  // Comercial (B2B)
  company        String?              // Nombre empresa (si es cliente corporativo)
  creditLimit    Decimal?  @db.Decimal(10, 2) @map("credit_limit")  // Límite de crédito
  currentDebt    Decimal   @db.Decimal(10, 2) @default(0) @map("current_debt")  // Deuda actual
  
  // Metadata
  tags           String[]             // ["VIP", "Mayorista", "Moroso"]
  notes          String?  @db.Text    // Notas internas
  isActive       Boolean  @default(true) @map("is_active")
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]
  credits      Credit[]
  payments     Payment[]

  @@unique([organizationId, rut])
  @@index([organizationId])
  @@index([name])
  @@index([email])
  @@map("customers")
}

// ============================================
// DOCUMENTS (SALES, QUOTES, INVOICES)
// ============================================

enum DocumentType {
  SALE          // Venta directa (POS)
  QUOTE         // Cotización
  INVOICE       // Factura
  RECEIPT       // Boleta
  CREDIT_NOTE   // Nota de Crédito
}

enum DocumentStatus {
  DRAFT         // Borrador
  PENDING       // Pendiente (cotización enviada)
  APPROVED      // Aprobada (cotización)
  PAID          // Pagada
  CANCELLED     // Anulada
}

enum PaymentMethod {
  CASH          // Efectivo
  CARD          // Tarjeta (Débito/Crédito)
  TRANSFER      // Transferencia bancaria
  CHECK         // Cheque
  CREDIT        // Crédito (Fiado)
  MULTI         // Pago mixto (varios métodos)
}

enum CardType {
  DEBIT
  CREDIT
}

enum CardProvider {
  TRANSBANK
  MERCADO_PAGO
  GETNET
  OTHER
}

enum CashRegisterStatus {
  OPEN          // Caja abierta (turno activo)
  CLOSED        // Caja cerrada (turno finalizado)
}

enum ProjectStatus {
  ACTIVE      // Proyecto en ejecución
  ON_HOLD     // Proyecto pausado
  COMPLETED   // Proyecto completado
  CANCELLED   // Proyecto cancelado
}

model Document {
  id             String         @id @default(cuid())
  organizationId String         @map("organization_id")
  customerId     String?        @map("customer_id")
  
  // Tipo y Estado
  type           DocumentType   @default(SALE)
  status         DocumentStatus @default(DRAFT)
  
  // Numeración (por organización y tipo)
  docNumber      Int            @map("doc_number")  // Autoincremental por tipo
  docPrefix      String?        @map("doc_prefix")   // Ej: "COT", "FAC", "BOL"
  
  // Fechas
  issuedAt       DateTime       @default(now()) @map("issued_at")
  dueAt          DateTime?      @map("due_at")  // Fecha vencimiento (para cotizaciones, facturas a crédito)
  paidAt         DateTime?      @map("paid_at")
  
  // Pago
  paymentMethod  PaymentMethod  @default(CASH) @map("payment_method")
  cardType       CardType?      @map("card_type")
  cardProvider   CardProvider?  @map("card_provider")
  cardCommissionRate   Decimal? @db.Decimal(5, 2) @map("card_commission_rate")
  cardCommissionAmount Decimal? @db.Decimal(10, 2) @map("card_commission_amount")
  
  // Montos (CLP, sin decimales en práctica pero Decimal para precisión)
  subtotal       Decimal        @db.Decimal(10, 2)
  taxRate        Decimal        @default(19) @db.Decimal(5, 2) @map("tax_rate") // IVA 19%
  taxAmount      Decimal        @db.Decimal(10, 2) @map("tax_amount")
  // Descuento global sobre el total de la venta (se aplica DESPUÉS de sumar items)
  // Este descuento es ADICIONAL a los descuentos individuales de cada item
  discount       Decimal        @default(0) @db.Decimal(10, 2)
  total          Decimal        @db.Decimal(10, 2)
  
  // Pago en efectivo (solo para CASH y MULTI)
  cashReceived   Decimal?       @db.Decimal(10, 2) @map("cash_received")
  cashChange     Decimal?       @db.Decimal(10, 2) @map("cash_change")
  
  // Metadata
  notes          String?        @db.Text
  createdBy      String         @map("created_by")  // User ID
  
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer       Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items          DocumentItem[]
  credits        Credit[]
  project        Project?       @relation("QuoteToProject")

  @@unique([organizationId, type, docNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([issuedAt])
  @@index([createdBy])
  @@index([cardType])
  @@index([cardProvider])
  @@map("documents")
}

model DocumentItem {
  id             String   @id @default(cuid())
  documentId     String   @map("document_id")
  productId      String?  @map("product_id")
  
  // Detalles del ítem (guardamos snapshot por si producto cambia)
  sku            String?
  name           String
  description    String?
  
  // Cantidades y precios
  quantity       Decimal  @db.Decimal(10, 3)  // 3 decimales para granel
  unit           String   @default("unidad")  // unidad, kg, litro, etc
  unitPrice      Decimal  @db.Decimal(10, 2) @map("unit_price")
  
  // Descuento e impuestos
  // IMPORTANTE: discount y discountPercent se sincronizan automáticamente en la UI
  // Si el usuario aplica 10% de descuento, se calcula el monto y viceversa
  // El descuento se aplica ANTES del cálculo de IVA: itemTotal = (qty * price) - discount
  discount       Decimal  @default(0) @db.Decimal(10, 2)  // Descuento en monto (CLP)
  discountPercent Decimal? @default(0) @db.Decimal(5, 2) @map("discount_percent") // Descuento en porcentaje
  taxRate        Decimal  @default(19) @db.Decimal(5, 2) @map("tax_rate")
  
  // Totales calculados
  subtotal       Decimal  @db.Decimal(10, 2)  // (quantity * unitPrice) - discount
  taxAmount      Decimal  @db.Decimal(10, 2) @map("tax_amount")
  total          Decimal  @db.Decimal(10, 2)  // subtotal + taxAmount
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  product        Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([productId])
  @@map("document_items")
}

model Project {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  quoteId        String?       @unique @map("quote_id")

  // Identificación
  name           String
  description    String?

  // Estado y control
  status         ProjectStatus @default(ACTIVE)
  contractedAmount Decimal?    @db.Decimal(12, 2) @map("contracted_amount")
  budget         Decimal?      @db.Decimal(12, 2) // Presupuesto inicial
  actualCost     Decimal       @default(0) @db.Decimal(12, 2) @map("actual_cost")
  startDate      DateTime      @default(now()) @map("start_date")
  endDate        DateTime?     @map("end_date")

  // Metadata
  notes          String?       @db.Text
  createdBy      String        @map("created_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quote          Document?     @relation("QuoteToProject", fields: [quoteId], references: [id], onDelete: SetNull)
  expenses       ProjectExpense[]
  milestones     ProjectMilestone[]
  resources      ProjectResource[]
  payments       ProjectPayment[]

  @@index([organizationId])
  @@index([status])
  @@index([startDate])
  @@map("projects")
}

model ProjectPayment {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  projectId      String        @map("project_id")

  amount         Decimal       @db.Decimal(12, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  paidAt         DateTime      @default(now()) @map("paid_at")

  reference      String?
  notes          String?       @db.Text
  createdBy      String        @map("created_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@index([paidAt])
  @@map("project_payments")
}

model ProjectResource {
  id               String       @id @default(cuid())
  organizationId   String       @map("organization_id")
  projectId        String       @map("project_id")
  milestoneId      String?      @map("milestone_id")
  productId        String?      @map("product_id")

  // Snapshot del recurso/material
  sku              String?
  name             String
  unit             String       @default("unidad")

  // Control de consumo y costo
  quantity         Decimal      @db.Decimal(10, 3) // Cantidad planificada
  consumedQuantity Decimal      @default(0) @db.Decimal(10, 3) @map("consumed_quantity")
  unitCost         Decimal      @db.Decimal(12, 2) @map("unit_cost")
  totalCost        Decimal      @db.Decimal(12, 2) @default(0) @map("total_cost")

  // Metadata
  notes            String?      @db.Text
  createdBy        String       @map("created_by")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project          Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone        ProjectMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  product          Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([milestoneId])
  @@index([productId])
  @@map("project_resources")
}

model ProjectMilestone {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  projectId      String       @map("project_id")

  // Información del hito
  title          String
  description    String?
  dueDate        DateTime?    @map("due_date")
  estimatedCost  Decimal?     @db.Decimal(12, 2) @map("estimated_cost")
  isCompleted    Boolean      @default(false) @map("is_completed")
  completedAt    DateTime?    @map("completed_at")
  position       Int          @default(0)

  // Metadata
  createdBy      String       @map("created_by")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  expenses       ProjectExpense[]
  resources      ProjectResource[]

  @@index([organizationId])
  @@index([projectId])
  @@index([isCompleted])
  @@index([dueDate])
  @@map("project_milestones")
}

model ProjectExpense {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  projectId      String       @map("project_id")
  milestoneId    String?      @map("milestone_id")

  // Información del gasto
  description    String
  category       String?      // Materiales, Mano de obra, Transporte, etc.
  amount         Decimal      @db.Decimal(12, 2)
  expenseDate    DateTime     @default(now()) @map("expense_date")

  // Metadata
  notes          String?      @db.Text
  createdBy      String       @map("created_by")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone      ProjectMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([milestoneId])
  @@index([expenseDate])
  @@map("project_expenses")
}

// ============================================
// CASH REGISTER (CIERRE DE CAJA)
// ============================================

model CashRegister {
  id             String             @id @default(cuid())
  organizationId String             @map("organization_id")
  
  // Control de sesión
  status         CashRegisterStatus @default(OPEN)
  openedBy       String             @map("opened_by")   // User ID del cajero
  closedBy       String?            @map("closed_by")   // User ID (puede ser diferente si admin cierra)
  
  // Fechas
  openedAt       DateTime           @default(now()) @map("opened_at")
  closedAt       DateTime?          @map("closed_at")
  
  // Montos de efectivo (solo efectivo, otros métodos no entran en arqueo)
  openingCash    Decimal            @db.Decimal(10, 2) @map("opening_cash")  // Fondo inicial
  expectedCash   Decimal            @db.Decimal(10, 2) @default(0) @map("expected_cash")  // Calculado: opening + ventas efectivo
  actualCash     Decimal?           @db.Decimal(10, 2) @map("actual_cash")    // Conteo físico al cerrar
  difference     Decimal?           @db.Decimal(10, 2)  // Diferencia: actual - expected (+ sobrante, - faltante)
  
  // Resumen de ventas del turno (todos los métodos)
  totalSales     Decimal            @db.Decimal(10, 2) @default(0) @map("total_sales")
  salesCount     Int                @default(0) @map("sales_count")
  
  // Metadata
  notes          String?            @db.Text  // Observaciones, justificación de diferencias
  
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  operationalExpenses OperationalExpense[]
  
  @@index([organizationId])
  @@index([openedBy])
  @@index([status])
  @@index([openedAt])
  @@map("cash_registers")
}

enum OperationalExpensePaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum TreasuryMovementType {
  INFLOW
  OUTFLOW
}

enum TreasuryMovementCategory {
  CAPITAL_INJECTION
  OWNER_WITHDRAWAL
  LOAN_IN
  LOAN_OUT
  ACCOUNT_PAYABLE_PAYMENT
  OTHER
}

enum TreasuryMovementSource {
  CASH
  BANK
  TRANSFER
  OTHER
}

model OperationalExpense {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  cashRegisterId String?  @map("cash_register_id")

  // Información del egreso
  title          String
  description    String?  @db.Text
  category       String?
  amount         Decimal  @db.Decimal(12, 2)
  paymentMethod  OperationalExpensePaymentMethod @default(CASH) @map("payment_method")
  expenseDate    DateTime @default(now()) @map("expense_date")

  // Metadata
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  cashRegister   CashRegister? @relation(fields: [cashRegisterId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([cashRegisterId])
  @@index([expenseDate])
  @@index([category])
  @@map("operational_expenses")
}

model TreasuryMovement {
  id               String                   @id @default(cuid())
  organizationId   String                   @map("organization_id")
  accountPayableId String?                  @map("account_payable_id")

  type             TreasuryMovementType
  category         TreasuryMovementCategory @default(OTHER)
  source           TreasuryMovementSource   @default(OTHER)

  title            String
  description      String?                  @db.Text
  reference        String?
  amount           Decimal                  @db.Decimal(12, 2)
  occurredAt       DateTime                 @default(now()) @map("occurred_at")

  createdBy        String                   @map("created_by")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")

  organization     Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  accountPayable   AccountPayable?          @relation(fields: [accountPayableId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([accountPayableId])
  @@index([occurredAt])
  @@index([type])
  @@index([category])
  @@map("treasury_movements")
}

// ============================================
// CREDITS & PAYMENTS (CUENTAS POR COBRAR)
// ============================================

enum CreditStatus {
  ACTIVE    // Crédito activo con saldo pendiente
  PAID      // Totalmente pagado
  CANCELED  // Anulado
  OVERDUE   // Vencido
}

model Credit {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  customerId     String       @map("customer_id")
  documentId     String?      @map("document_id")  // Venta que generó el crédito (opcional)
  
  // Montos
  amount         Decimal      @db.Decimal(10, 2)  // Monto total del crédito
  balance        Decimal      @db.Decimal(10, 2)  // Saldo pendiente (se reduce con cada pago)
  
  // Control
  status         CreditStatus @default(ACTIVE)
  dueDate        DateTime     @map("due_date")     // Fecha de vencimiento
  
  // Metadata
  description    String?      @db.Text             // Descripción o concepto
  notes          String?      @db.Text             // Notas internas
  
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  document       Document?    @relation(fields: [documentId], references: [id], onDelete: SetNull)
  payments       Payment[]
  
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@map("credits")
}

model Payment {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  creditId       String   @map("credit_id")
  customerId     String   @map("customer_id")  // Denormalizado para queries rápidas
  
  // Pago
  amount         Decimal  @db.Decimal(10, 2)  // Monto pagado
  paymentMethod  String   @map("payment_method")  // "CASH", "CARD", "TRANSFER", etc.
  
  // Metadata
  reference      String?  // Número de transferencia, voucher, etc.
  notes          String?  @db.Text
  
  paidAt         DateTime @default(now()) @map("paid_at")  // Fecha del pago
  createdAt      DateTime @default(now()) @map("created_at")
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  credit         Credit       @relation(fields: [creditId], references: [id], onDelete: Cascade)
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([creditId])
  @@index([customerId])
  @@index([paidAt])
  @@map("payments")
}

